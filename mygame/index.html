<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>My NFT Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            font-weight: 600;
        }
        
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #000000;
            border-bottom: 1px solid #333333;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #888888;
        }
        
        .user-name {
            font-size: 16px;
            font-weight: 700;
        }
        
        .currency-info {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .currency-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #1a1a1a;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
        }
        
        .plus-btn {
            background: #ffffff;
            border: none;
            border-radius: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000000;
            cursor: pointer;
            font-size: 16px;
        }

        .rules-btn {
            background: #333333;
            border: none;
            border-radius: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            background: #000000;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
        }
        
        .center-area {
            text-align: center;
            padding: 60px 20px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000000;
            margin-bottom: 80px;
        }
        
        .center-logo {
            font-size: 120px;
            color: #333333;
            opacity: 0.6;
            font-weight: 200;
        }
        
        .center-message {
            font-size: 16px;
            color: #888888;
            margin-top: 20px;
        }
        
        .center-nft-img {
            width: 180px;
            height: 180px;
            border-radius: 16px;
            object-fit: cover;
            margin-bottom: 16px;
            border: 2px solid #333333;
        }
        
        .center-nft-name {
            font-size: 22px;
            font-weight: 700;
        }
        
        .center-nft-status {
            font-size: 16px;
            color: #888888;
            background: #1a1a1a;
            padding: 6px 12px;
            border-radius: 12px;
        }
        
        .play-btn {
            background: #ffffff;
            border: none;
            color: #000000;
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .play-btn:hover {
            background: #eeeeee;
        }
        
        .play-btn:disabled {
            background: #333333;
            color: #888888;
            cursor: not-allowed;
        }
        
        .bottom-nav {
            display: flex;
            background: #000000;
            border-top: 1px solid #333333;
        }
        
        .nav-item {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #888888;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: color 0.2s ease;
        }
        
        .nav-item.active {
            color: #ffffff;
        }
        
        .nav-item i {
            font-size: 20px;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #ffffff;
        }
        
        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }
        
        .nft-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            border: 1px solid #333333;
        }
        
        .nft-card-img {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 8px;
        }
        
        .nft-card-name {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .nft-card-price {
            font-size: 12px;
            color: #888888;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .nft-card-btn {
            background: #ffffff;
            border: none;
            color: #000000;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-bottom: 4px;
        }
        
        .nft-card-btn.secondary {
            background: #333333;
            color: #ffffff;
            margin-bottom: 0;
        }
        
        .battle-arena {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .battle-participants {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .participant {
            text-align: center;
            flex: 1;
        }
        
        .participant-img {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            object-fit: cover;
            margin-bottom: 12px;
            border: 2px solid #333333;
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-5px, 0); }
            50% { transform: translate(5px, 0); }
            75% { transform: translate(-5px, 0); }
            100% { transform: translate(0, 0); }
        }
        
        .participant-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .hp-container {
            background: #000000;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 8px;
        }
        
        .hp-bar {
            height: 12px;
            background: #d32f2f;
            border-radius: 6px;
            transition: width 0.8s ease;
            position: relative;
        }
        
        .hp-bar.low {
            background: #ff5722;
            animation: pulse 0.5s infinite alternate;
        }
        
        @keyframes pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
        
        .hp-text {
            font-size: 14px;
            color: #cccccc;
            font-weight: 600;
        }
        
        .vs-text {
            font-size: 28px;
            font-weight: bold;
            color: #666666;
            margin: 0 20px;
        }
        
        .battle-log {
            background: #000000;
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            font-size: 16px;
            color: #cccccc;
            min-height: 80px;
            border: 1px solid #333333;
            font-weight: 500;
        }
        
        .battle-result {
            text-align: center;
            padding: 24px;
            font-size: 24px;
            font-weight: 700;
        }
        
        .battle-result.win {
            color: #4caf50;
        }
        
        .battle-result.lose {
            color: #f44336;
        }
        
        .reward-info {
            border: 1px solid #34623f;
            border-radius: 12px;
            padding: 16px;
            margin: 15px 0;
            text-align: center;
            font-size: 16px;
        }
        
        .reward-info.win {
            background: #1a472a;
        }
        
        .reward-info.lose {
            background: #4a1a1a;
            border-color: #623f3f;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            background: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #888888;
        }
        
        .profile-info h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .profile-stats {
            font-size: 14px;
            color: #888888;
        }
        
        .friends-placeholder {
            text-align: center;
            padding: 80px 20px;
            color: #888888;
            font-size: 18px;
        }

        .battle-history-item {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #333333;
        }

        .battle-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .battle-result-text {
            font-size: 16px;
            font-weight: 700;
        }

        .battle-result-text.win {
            color: #4caf50;
        }

        .battle-result-text.lose {
            color: #f44336;
        }

        .battle-history-nfts {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .history-nft {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .history-nft-img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 5px;
            border: 1px solid #333333;
        }

        .history-nft-name {
            font-size: 12px;
            text-align: center;
            color: #cccccc;
        }

        .history-vs {
            font-size: 20px;
            color: #666666;
            margin: 0 10px;
        }
        
        .searching-overlay, .coin-toss-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .searching-animation {
            width: 60px;
            height: 60px;
            border: 3px solid #333333;
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .coin-container {
            perspective: 1000px;
            margin-bottom: 20px;
        }
        
        .coin {
            width: 150px;
            height: 150px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.3s;
        }
        
        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 50%;
            overflow: hidden;
            background: #333333;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        
        .back {
            transform: rotateY(180deg);
        }
        
        .coin img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        @keyframes flipFront {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(1800deg); }
        }
        
        @keyframes flipBack {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(1980deg); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .searching-text {
            font-size: 18px;
            color: #cccccc;
            text-align: center;
        }
        
        .back-btn {
            background: #333333;
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .purchase-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .purchase-content {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }

        .purchase-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .purchase-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .purchase-btn {
            background: #ffffff;
            color: #000000;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            border: none;
        }

        .telegram-pay-btn {
            background: linear-gradient(45deg, #0088cc, #00a2e4) !important;
            color: white !important;
            border: 2px solid #00a2e4 !important;
        }

        .close-purchase {
            margin-top: 20px;
            color: #888888;
            cursor: pointer;
        }

        .clickable-link {
            color: #ffd700;
            text-decoration: underline;
            cursor: pointer;
        }

        .withdraw-section {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .withdraw-btn {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
        }

        .withdraw-btn:disabled {
            background: #333333;
            color: #888888;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="top-bar">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">👤</div>
                <div class="user-name" id="user-name">Игрок</div>
            </div>
            <div class="currency-info">
                <button class="rules-btn" onclick="showRules()">📖</button>
                <div class="currency-item">
                    <i class="fas fa-star" style="color: #ffd700;"></i>
                    <span id="star-count">0</span>
                </div>
                <button class="plus-btn" onclick="showPurchaseMenu()">+</button>
            </div>
        </div>

        <div class="content-area">
            <div id="main-screen" class="screen active">
                <div class="main-content">
                    <div id="center-area" class="center-area">
                        <div id="center-content"></div>
                    </div>
                    <button class="play-btn" id="play-button" onclick="startBattleSearch()">ДУЭЛЬ</button>
                </div>
            </div>

            <div id="collection-screen" class="screen">
                <div class="main-content">
                    <h2 class="section-title">Коллекция</h2>
                    <div id="collection-grid" class="nft-grid"></div>
                    <button class="play-btn" onclick="openShop()" style="margin-top: 20px;">
                        Купить NFT
                    </button>
                </div>
            </div>

            <div id="shop-screen" class="screen">
                <div class="main-content">
                    <h2 class="section-title">Магазин NFT</h2>
                    <div id="shop-grid" class="nft-grid"></div>
                </div>
            </div>

            <div id="battle-screen" class="screen">
                <div class="main-content">
                    <h2 class="section-title">Дуэль</h2>
                    <div class="battle-arena">
                        <div class="battle-participants">
                            <div class="participant left">
                                <img id="player-img" class="participant-img" src="" alt="Player NFT">
                                <div class="participant-name">Вы</div>
                                <div class="hp-container">
                                    <div id="player-hp-bar" class="hp-bar"></div>
                                </div>
                                <div id="player-hp-text" class="hp-text">100/100 HP</div>
                            </div>
                            <div class="vs-text">VS</div>
                            <div class="participant right">
                                <img id="bot-img" class="participant-img" src="" alt="Bot NFT">
                                <div class="participant-name">Оппонент</div>
                                <div class="hp-container">
                                    <div id="bot-hp-bar" class="hp-bar"></div>
                                </div>
                                <div id="bot-hp-text" class="hp-text">100/100 HP</div>
                            </div>
                        </div>
                        <div id="battle-log" class="battle-log">Подготовка к дуэли...</div>
                        <div id="battle-result" class="battle-result" style="display: none;"></div>
                        <div id="reward-info" class="reward-info" style="display: none;"></div>
                        <button id="back-to-menu-btn" class="back-btn" onclick="backToMainFromBattle()" style="display: none; width: 100%;">
                            Вернуться в меню
                        </button>
                    </div>
                </div>
            </div>

            <div id="profile-screen" class="screen">
                <div class="main-content">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profile-avatar">👤</div>
                        <div class="profile-info">
                            <h2 id="profile-name">Игрок</h2>
                            <div class="profile-stats">
                                <div>NFT в коллекции: <span id="profile-nft-count">0</span></div>
                                <div>Звёзд заработано: <span id="profile-stars-earned">0</span></div>
                                <div>Дуэли проведено: <span id="profile-battles-count">0</span></div>
                                <div>Звёзд для вывода: <span id="withdrawable-stars">0</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="withdraw-section">
                        <h3>Вывод звёзд</h3>
                        <p style="color: #888888; margin: 10px 0;">Минимальная сумма для вывода: 300 звёзд</p>
                        <button class="withdraw-btn" id="withdraw-btn" onclick="initiateWithdrawal()">
                            Вывести звёзды
                        </button>
                    </div>

                    <button class="play-btn" onclick="showBattleHistory()" style="margin-bottom: 15px; font-size: 16px;">
                        История дуэлей
                    </button>
                    <h3 class="section-title" style="font-size: 18px;">Моя коллекция</h3>
                    <div id="profile-collection" class="nft-grid"></div>
                </div>
            </div>

            <div id="battle-history-screen" class="screen">
                <div class="main-content">
                    <h2 class="section-title">История дуэлей</h2>
                    <div id="battle-history-list">
                    </div>
                    <button class="play-btn" onclick="backToProfile()" style="margin-top: 20px;">
                        Назад в профиль
                    </button>
                </div>
            </div>

            <div id="friends-screen" class="screen">
                <div class="main-content">
                    <div class="friends-placeholder">
                        <h2>Hello World</h2>
                        <p style="margin-top: 20px; color: #666;">Раздел в разработке</p>
                    </div>
                </div>
            </div>

            <div id="upgrade-screen" class="screen">
                <div class="main-content">
                    <h2 class="section-title">Апгрейд</h2>
                    <div class="friends-placeholder">
                        <p style="margin-top: 20px; color: #666;">Раздел в разработке</p>
                    </div>
                </div>
            </div>

            <div id="rules-screen" class="screen">
                <div class="main-content">
                    <h2 class="section-title">Правила дуэлей</h2>
                    <div style="background: #1a1a1a; border-radius: 16px; padding: 20px; margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <h3 style="color: #ffd700; margin-bottom: 8px;">🎯 Как играть:</h3>
                            <p style="color: #cccccc; line-height: 1.5;">1. Купи NFT в магазине<br>2. Выбери NFT для дуэли в коллекции<br>3. Нажми "ДУЭЛЬ" на главном экране<br>4. Сражайся и побеждай!</p>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <h3 style="color: #ffd700; margin-bottom: 8px;">🎲 Механика:</h3>
                            <p style="color: #cccccc; line-height: 1.5;">• Всё происходит случайно<br>• Шанс критического удара: 15%<br>• Шанс промаха: 8%<br>• При низком HP шанс крита увеличивается</p>
                        </div>
                        <div>
                            <h3 style="color: #ffd700; margin-bottom: 8px;">🏆 Награды:</h3>
                            <p style="color: #cccccc; line-height: 1.5;">• За победу получаешь NFT противника<br>• За поражение теряешь свой NFT<br>• Участие в дуэли стоит 10 звёзд</p>
                        </div>
                    </div>
                    <button class="play-btn" onclick="backToMainFromRules()">Назад</button>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchScreen('main')">
                <i class="fas fa-home"></i>
                <span>Главная</span>
            </button>
            <button class="nav-item" onclick="switchScreen('collection')">
                <i class="fas fa-box-open"></i>
                <span>Коллекция</span>
            </button>
            <button class="nav-item" onclick="switchScreen('upgrade')">
                <i class="fas fa-arrow-up"></i>
                <span>Апгрейд</span>
            </button>
            <button class="nav-item" onclick="switchScreen('profile')">
                <i class="fas fa-user"></i>
                <span>Профиль</span>
            </button>
            <button class="nav-item" onclick="switchScreen('friends')">
                <i class="fas fa-users"></i>
                <span>Друзья</span>
            </button>
        </div>

        <div id="searching-overlay" class="searching-overlay" style="display: none;">
            <div class="searching-animation"></div>
            <div class="searching-text">
                Поиск оппонента...<br>
                <span id="search-status">Подключение к серверу</span>
            </div>
        </div>

        <div id="coin-toss-overlay" class="coin-toss-overlay" style="display: none;">
            <div class="coin-container">
                <div id="coin" class="coin">
                    <div class="front">
                        <img id="coin-front" src="" alt="Player">
                    </div>
                    <div class="back">
                        <img id="coin-back" src="" alt="Bot">
                    </div>
                </div>
            </div>
            <div id="coin-result-text" class="searching-text"></div>
        </div>

        <div id="purchase-overlay" class="purchase-overlay">
            <div class="purchase-content">
                <div class="purchase-title">Купить звёзды</div>
                <div class="purchase-options">
                    <button class="purchase-btn" onclick="purchaseStars(50)">50 звёзд</button>
                    <button class="purchase-btn" onclick="purchaseStars(100)">100 звёзд</button>
                    <button class="purchase-btn" onclick="purchaseStars(200)">200 звёзд</button>
                    <button class="purchase-btn" onclick="purchaseStars(500)">500 звёзд</button>
                    <button class="purchase-btn telegram-pay-btn" onclick="buyStarsWithTelegram(1000, 1)">
                        💎 1000 звёзд (1 звезда TG)
                    </button>
                    <button class="purchase-btn telegram-pay-btn" onclick="buyStarsWithTelegram(5000, 1)">
                        💎 5000 звёзд (1 звезда TG)
                    </button>
                </div>
                <div class="close-purchase" onclick="closePurchaseMenu()">Закрыть</div>
            </div>
        </div>
    </div>

    <script>
        Telegram.WebApp.ready();

        const cloudStorage = Telegram.WebApp.CloudStorage;

        const nftTemplates = [
            { name: 'Bday candle', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/bdaycandle.gif', tier: 'basic' },
            { name: 'Big Year', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/bigyear.gif', tier: 'basic' },
            { name: 'Durev', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/durev.gif', tier: 'basic' },
            { name: 'Electric Skull', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/electricskull.gif', tier: 'premium' },
            { name: 'Jelly Bean', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/jellybean.gif', tier: 'basic' },
            { name: 'Low Rider', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/lowrider.gif', tier: 'basic' },
            { name: 'Siber', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/siber.gif', tier: 'basic' },
            { name: 'Skull Flower', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/SkullFlower_holders.gif', tier: 'basic' },
            { name: 'Snoop Dog', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/SnoopDogSkins.gif', tier: 'basic' },
            { name: 'Snoops Cigars', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/SnoopsCigars.gif', tier: 'premium' },
            { name: 'Swag Bag', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/Swag_Bag.gif', tier: 'basic' },
            { name: 'Vintage Cigar', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/VintageCigar.gif', tier: 'basic' },
            { name: 'West Side', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/WestSide.gif', tier: 'premium' },
            { name: 'Bday candle 2v', img: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/1.gif', tier: 'premium' }
        ];
        
        const nftPrices = [100, 150, 200, 250, 440, 350, 240, 85, 200, 300, 700, 500, 220, 450];

        let stars = 100;
        let collection = [];
        let activeBattleNft = null;
        let totalStarsEarned = 0;
        let battleHistory = [];
        let withdrawableStars = 0;
        
        const tgUser = Telegram.WebApp.initDataUnsafe?.user;
        let userName = tgUser?.first_name || 'Игрок';
        let userAvatar = tgUser?.photo_url || '👤';
        
        let playerHP = 100;
        let botHP = 100;
        let botNft = null;
        let battleInProgress = false;
        let currentScreen = 'main';

        init();

        async function init() {
            await loadData();
            updateUI();
            renderCenterArea();
            renderCollection();
            renderShop();
            renderProfile();
            updateUserInfo();
            setupTelegramPayments();
        }

        async function loadData() {
            try {
                const [starsStr, collectionStr, activeNftStr, totalEarnedStr, historyStr, withdrawableStr] = await Promise.all([
                    getCloudItem('stars'),
                    getCloudItem('collection'),
                    getCloudItem('activeBattleNft'),
                    getCloudItem('totalStarsEarned'),
                    getCloudItem('battleHistory'),
                    getCloudItem('withdrawableStars')
                ]);
                stars = parseInt(starsStr) || 100;
                collection = JSON.parse(collectionStr) || [];
                activeBattleNft = JSON.parse(activeNftStr) || null;
                totalStarsEarned = parseInt(totalEarnedStr) || 0;
                battleHistory = JSON.parse(historyStr) || [];
                withdrawableStars = parseInt(withdrawableStr) || 0;
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function saveData() {
            try {
                await Promise.all([
                    setCloudItem('stars', stars.toString()),
                    setCloudItem('collection', JSON.stringify(collection)),
                    setCloudItem('activeBattleNft', JSON.stringify(activeBattleNft)),
                    setCloudItem('totalStarsEarned', totalStarsEarned.toString()),
                    setCloudItem('battleHistory', JSON.stringify(battleHistory)),
                    setCloudItem('withdrawableStars', withdrawableStars.toString())
                ]);
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function getCloudItem(key) {
            return new Promise((resolve, reject) => {
                cloudStorage.getItem(key, (error, value) => {
                    if (error) reject(error);
                    else resolve(value);
                });
            });
        }

        function setCloudItem(key, value) {
            return new Promise((resolve, reject) => {
                cloudStorage.setItem(key, value, (error, success) => {
                    if (error || !success) reject(error);
                    else resolve();
                });
            });
        }

        function updateUserInfo() {
            document.getElementById('user-name').textContent = userName;
            document.getElementById('profile-name').textContent = userName;
            
            if (typeof userAvatar === 'string' && userAvatar.startsWith('http')) {
                document.getElementById('user-avatar').innerHTML = `<img src="${userAvatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                document.getElementById('profile-avatar').innerHTML = `<img src="${userAvatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
            }
        }

        function updateUI() {
            document.getElementById('star-count').textContent = stars;
            document.getElementById('profile-nft-count').textContent = collection.length;
            document.getElementById('profile-stars-earned').textContent = totalStarsEarned;
            document.getElementById('profile-battles-count').textContent = battleHistory.length;
            document.getElementById('withdrawable-stars').textContent = withdrawableStars;
            
            const withdrawBtn = document.getElementById('withdraw-btn');
            if (withdrawableStars >= 300) {
                withdrawBtn.disabled = false;
                withdrawBtn.textContent = `Вывести ${withdrawableStars} звёзд`;
            } else {
                withdrawBtn.disabled = true;
                withdrawBtn.textContent = `Минимум 300 звёзд для вывода`;
            }
            
            updatePlayButton();
            saveData();
        }

        function updatePlayButton() {
            const playBtn = document.getElementById('play-button');
            if (!activeBattleNft) {
                playBtn.textContent = 'Выберите NFT для дуэли';
                playBtn.disabled = true;
            } else if (stars < 10) {
                playBtn.textContent = 'Недостаточно звёзд (10 звёзд)';
                playBtn.disabled = true;
            } else {
                playBtn.textContent = 'ДУЭЛЬ (10 звёзд)';
                playBtn.disabled = false;
            }
        }

        function showPurchaseMenu() {
            document.getElementById('purchase-overlay').style.display = 'flex';
        }

        function closePurchaseMenu() {
            document.getElementById('purchase-overlay').style.display = 'none';
        }

        function purchaseStars(amount) {
            stars += amount;
            totalStarsEarned += amount;
            updateUI();
            alert(`🎉 Куплено ${amount} звёзд!`);
            closePurchaseMenu();
        }

        function setupTelegramPayments() {
            Telegram.WebApp.onEvent('invoiceClosed', function(event) {
                console.log('Invoice closed:', event);
                if (event.status === 'paid') {
                    const payload = JSON.parse(event.payload || '{}');
                    const starsAmount = payload.starsAmount || 1000;
                    
                    stars += starsAmount;
                    totalStarsEarned += starsAmount;
                    updateUI();
                    
                    Telegram.WebApp.showAlert(`🎉 Успешно! Получено ${starsAmount} звёзд!`);
                }
            });
        }

        function buyStarsWithTelegram(starsAmount, telegramStarsPrice) {
            try {
                const tg = Telegram.WebApp;
                const user = tg.initDataUnsafe.user;
                
                const payload = JSON.stringify({
                    userId: user?.id,
                    starsAmount: starsAmount,
                    timestamp: Date.now(),
                    type: 'stars_purchase'
                });

                tg.openInvoice({
                    title: `Покупка ${starsAmount} игровых звёзд`,
                    description: `Пополнение счета для NFT дуэлей`,
                    payload: payload,
                    provider_token: '',
                    currency: 'XTR',
                    prices: [{ label: `${starsAmount} игровых звёзд`, amount: telegramStarsPrice * 100 }],
                    photo_url: 'https://hdptohtdpkothkoefgefsaefefgefgsewef.vercel.app/mygame/imgg/1.gif',
                    need_name: false,
                    need_phone_number: false,
                    need_email: false,
                    need_shipping_address: false,
                    is_flexible: false
                });
                
            } catch (error) {
                console.error('Error creating invoice:', error);
                Telegram.WebApp.showAlert('Ошибка при создании счета. Попробуйте позже.');
            }
        }

        function initiateWithdrawal() {
            if (withdrawableStars < 300) {
                Telegram.WebApp.showAlert('Минимальная сумма для вывода: 300 звёзд');
                return;
            }
            
            Telegram.WebApp.showConfirm(
                `Вы уверены, что хотите вывести ${withdrawableStars} звёзд?`,
                function(confirmed) {
                    if (confirmed) {
                        processWithdrawal();
                    }
                }
            );
        }

        function processWithdrawal() {
            Telegram.WebApp.showPopup({
                title: 'Запрос на вывод',
                message: `Запрос на вывод ${withdrawableStars} звёзд отправлен администратору. Ожидайте обработки в течение 24 часов.`,
                buttons: [{ type: 'ok', text: 'Понятно' }]
            }, function(btnId) {
                withdrawableStars = 0;
                updateUI();
            });
        }

        function startBattleSearch() {
            if (!activeBattleNft || stars < 10) return;
            
            stars -= 10;
            updateUI();
            
            document.getElementById('searching-overlay').style.display = 'flex';
            
            const searchStatuses = [
                'Подключение к серверу...',
                'Поиск игроков...',
                'Проверка совместимости...',
                'Оппонент найден!'
            ];
            
            let statusIndex = 0;
            const statusElement = document.getElementById('search-status');
            
            const updateStatus = () => {
                if (statusIndex < searchStatuses.length) {
                    statusElement.textContent = searchStatuses[statusIndex];
                    statusIndex++;
                    if (statusIndex < searchStatuses.length) {
                        setTimeout(updateStatus, 800);
                    } else {
                        setTimeout(startBattle, 500);
                    }
                }
            };
            
            updateStatus();
        }

        function startBattle() {
            document.getElementById('searching-overlay').style.display = 'none';
            
            const playerPrice = activeBattleNft.buyPrice;
            let suitableNfts = [];
            
            nftTemplates.forEach((template, index) => {
                if (nftPrices[index] <= playerPrice + 50) {
                    suitableNfts.push({ ...template, price: nftPrices[index] });
                }
            });
            
            if (suitableNfts.length === 0) {
                const randomIndex = Math.floor(Math.random() * nftTemplates.length);
                botNft = { ...nftTemplates[randomIndex], price: nftPrices[randomIndex] };
            } else {
                const randomIndex = Math.floor(Math.random() * suitableNfts.length);
                botNft = suitableNfts[randomIndex];
            }
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('battle-screen').classList.add('active');
            
            document.getElementById('coin-toss-overlay').style.display = 'flex';
            document.getElementById('coin-front').src = activeBattleNft.img;
            document.getElementById('coin-back').src = botNft.img;
            document.getElementById('coin-result-text').textContent = '';
            const coin = document.getElementById('coin');
            coin.style.animation = 'none';
            
            setTimeout(() => {
                const playerFirst = Math.random() < 0.5;
                const animationName = playerFirst ? 'flipFront' : 'flipBack';
                coin.style.animation = `${animationName} 3s ease-out forwards`;
                
                coin.addEventListener('animationend', () => {
                    const text = playerFirst ? 'Вы ходите первым!' : 'Оппонент ходит первым!';
                    document.getElementById('coin-result-text').textContent = text;
                    
                    setTimeout(() => {
                        document.getElementById('coin-toss-overlay').style.display = 'none';
                        initializeBattle(playerFirst);
                    }, 2000);
                }, {once: true});
            }, 1000);
        }

        function initializeBattle(playerFirst) {
            playerHP = 100;
            botHP = 100;
            battleInProgress = true;
            
            document.getElementById('player-img').src = activeBattleNft.img;
            document.getElementById('bot-img').src = botNft.img;
            
            document.getElementById('battle-result').style.display = 'none';
            document.getElementById('reward-info').style.display = 'none';
            document.getElementById('back-to-menu-btn').style.display = 'none';
            
            const vsText = document.querySelector('.vs-text');
            const playerHpContainer = document.querySelector('.participant.left .hp-container');
            const botHpContainer = document.querySelector('.participant.right .hp-container');
            const playerHpText = document.getElementById('player-hp-text');
            const botHpText = document.getElementById('bot-hp-text');
            const playerName = document.querySelector('.participant.left .participant-name');
            const botName = document.querySelector('.participant.right .participant-name');
            const playerParticipant = document.querySelector('.participant.left');
            const botParticipant = document.querySelector('.participant.right');
            
            vsText.style.opacity = 0;
            playerHpContainer.style.opacity = 0;
            botHpContainer.style.opacity = 0;
            playerHpText.style.opacity = 0;
            botHpText.style.opacity = 0;
            playerName.style.opacity = 0;
            botName.style.opacity = 0;
            playerParticipant.style.opacity = 0;
            playerParticipant.style.transform = 'translateX(-100vw)';
            botParticipant.style.opacity = 0;
            botParticipant.style.transform = 'translateX(100vw)';
            
            setTimeout(() => {
                playerParticipant.style.transition = 'transform 1s ease, opacity 1s ease';
                botParticipant.style.transition = 'transform 1s ease, opacity 1s ease';
                playerParticipant.style.transform = 'translateX(0)';
                playerParticipant.style.opacity = 1;
                botParticipant.style.transform = 'translateX(0)';
                botParticipant.style.opacity = 1;
            }, 100);
            
            setTimeout(() => {
                botParticipant.style.transition = 'transform 0.5s ease';
                botParticipant.style.transform = 'scale(0.8) translateY(-20px)';
            }, 2100);
            
            setTimeout(() => {
                vsText.style.transition = 'opacity 0.5s ease';
                vsText.style.opacity = 1;
                vsText.classList.add('fade-in');
            }, 2100 + 500);
            
            setTimeout(() => {
                playerHpContainer.style.transition = 'opacity 0.5s ease';
                botHpContainer.style.transition = 'opacity 0.5s ease';
                playerHpContainer.style.opacity = 1;
                botHpContainer.style.opacity = 1;
                playerHpText.style.transition = 'opacity 0.5s ease';
                botHpText.style.transition = 'opacity 0.5s ease';
                playerHpText.style.opacity = 1;
                botHpText.style.opacity = 1;
                updateHPBars();
            }, 2100 + 500 + 500);
            
            setTimeout(() => {
                playerName.style.transition = 'opacity 0.5s ease';
                botName.style.transition = 'opacity 0.5s ease';
                playerName.style.opacity = 1;
                botName.style.opacity = 1;
            }, 2100 + 500 + 500 + 500);
            
            setTimeout(() => {
                const log = document.getElementById('battle-log');
                if (playerFirst) {
                    log.textContent = 'Вы атакуете первыми! Приготовьтесь...';
                    setTimeout(() => performAttack(true), 2000);
                } else {
                    log.textContent = 'Оппонент атакует первым! Защищайтесь...';
                    setTimeout(() => performAttack(false), 2000);
                }
            }, 2100 + 500 + 500 + 500 + 500);
        }

        function performAttack(isPlayerTurn) {
            if (!battleInProgress) return;
            
            let damage;
            const isLowHP = (isPlayerTurn ? botHP : playerHP) <= 25;
            const isCritical = Math.random() < (isLowHP ? 0.3 : 0.15);
            
            if (isCritical) {
                damage = Math.floor(Math.random() * 30) + 45;
            } else {
                damage = Math.floor(Math.random() * 35) + 8;
            }
            
            const isMiss = Math.random() < 0.08;
            const log = document.getElementById('battle-log');
            let targetImg;
            
            if (isPlayerTurn) {
                targetImg = document.getElementById('bot-img');
            } else {
                targetImg = document.getElementById('player-img');
            }
            
            if (isMiss) {
                if (isPlayerTurn) {
                    log.textContent = 'Промах! Ваша атака не попала в цель!';
                } else {
                    log.textContent = 'Уклонение! Вы избежали атаки оппонента!';
                }
            } else {
                if (isPlayerTurn) {
                    botHP = Math.max(0, botHP - damage);
                    if (isCritical) {
                        log.textContent = `КРИТИЧЕСКИЙ УДАР! Вы наносите ${damage} урона оппоненту!`;
                    } else {
                        log.textContent = `Вы наносите ${damage} урона оппоненту!`;
                    }
                } else {
                    playerHP = Math.max(0, playerHP - damage);
                    if (isCritical) {
                        log.textContent = `КРИТИЧЕСКАЯ АТАКА ОППОНЕНТА! Вы получаете ${damage} урона!`;
                    } else {
                        log.textContent = `Оппонент наносит вам ${damage} урона!`;
                    }
                }
                targetImg.classList.add('shake');
                setTimeout(() => targetImg.classList.remove('shake'), 500);
            }
            
            updateHPBars();
            
            if ((playerHP <= 15 || botHP <= 15) && playerHP > 0 && botHP > 0) {
                setTimeout(() => {
                    log.textContent = 'Критическое состояние! Следующий удар может быть решающим!';
                }, 1000);
            }
            
            if (playerHP <= 0 || botHP <= 0) {
                setTimeout(() => endBattle(), 2000);
            } else {
                const delay = Math.random() * 1000 + 1500;
                setTimeout(() => performAttack(!isPlayerTurn), delay);
            }
        }

        function updateHPBars() {
            const playerBar = document.getElementById('player-hp-bar');
            const botBar = document.getElementById('bot-hp-bar');
            const playerText = document.getElementById('player-hp-text');
            const botText = document.getElementById('bot-hp-text');
            
            playerBar.style.width = `${playerHP}%`;
            botBar.style.width = `${botHP}%`;
            
            if (playerHP <= 20) playerBar.classList.add('low');
            else playerBar.classList.remove('low');
            
            if (botHP <= 20) botBar.classList.add('low');
            else botBar.classList.remove('low');
            
            playerText.textContent = `${playerHP}/100 HP`;
            botText.textContent = `${botHP}/100 HP`;
        }

        function endBattle() {
            battleInProgress = false;
            const resultDiv = document.getElementById('battle-result');
            const rewardDiv = document.getElementById('reward-info');
            const log = document.getElementById('battle-log');
            
            let result;
            let reward;
            let starsWon = 0;
            
            if (playerHP > 0) {
                resultDiv.textContent = 'ПОБЕДА!';
                resultDiv.className = 'battle-result win';
                log.textContent = 'Невероятная победа! Вы оказались сильнее!';
                
                const rewardNft = { ...botNft, buyPrice: botNft.price };
                collection.push(rewardNft);
                
                starsWon = Math.floor(Math.random() * 50) + 50;
                stars += starsWon;
                withdrawableStars += starsWon;
                
                rewardDiv.innerHTML = `Вы получили NFT: ${botNft.name}!<br>+${starsWon} звёзд для вывода`;
                rewardDiv.classList.add('win');
                rewardDiv.classList.remove('lose');
                
                result = 'win';
                reward = botNft.name;
            } else {
                resultDiv.textContent = 'ПОРАЖЕНИЕ!';
                resultDiv.className = 'battle-result lose';
                log.textContent = 'Вы потерпели поражение...';
                
                if (activeBattleNft) {
                    collection = collection.filter(nft => 
                        nft.name !== activeBattleNft.name || nft.img !== activeBattleNft.img
                    );
                    reward = `Потерян: ${activeBattleNft.name}`;
                    activeBattleNft = null;
                    rewardDiv.innerHTML = `Ваш NFT захвачен противником!`;
                    rewardDiv.classList.add('lose');
                    rewardDiv.classList.remove('win');
                }
                
                result = 'lose';
            }
            
            battleHistory.push({
                date: new Date().toLocaleDateString('ru-RU'),
                result: result,
                playerNft: {
                    name: activeBattleNft ? activeBattleNft.name : 'Неизвестно',
                    img: activeBattleNft ? activeBattleNft.img : ''
                },
                botNft: {
                    name: botNft.name,
                    img: botNft.img
                },
                reward: reward,
                starsWon: starsWon
            });
            
            resultDiv.style.display = 'block';
            rewardDiv.style.display = 'block';
            document.getElementById('back-to-menu-btn').style.display = 'block';
            updateUI();
        }

        function backToMainFromBattle() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('main-screen').classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[0].classList.add('active');
            
            updateUI();
            renderCenterArea();
            currentScreen = 'main';
        }

        function switchScreen(screen) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            if (screen === 'main') {
                document.getElementById('main-screen').classList.add('active');
                renderCenterArea();
            } else if (screen === 'collection') {
                document.getElementById('collection-screen').classList.add('active');
                renderCollection();
            } else if (screen === 'upgrade') {
                document.getElementById('upgrade-screen').classList.add('active');
            } else if (screen === 'profile') {
                document.getElementById('profile-screen').classList.add('active');
                renderProfile();
            } else if (screen === 'friends') {
                document.getElementById('friends-screen').classList.add('active');
            }
            
            currentScreen = screen;
        }

        function openShop() {
            document.getElementById('collection-screen').classList.remove('active');
            document.getElementById('shop-screen').classList.add('active');
            renderShop();
        }

        function backToCollection() {
            document.getElementById('shop-screen').classList.remove('active');
            document.getElementById('collection-screen').classList.add('active');
        }

        function renderCenterArea() {
            const centerDiv = document.getElementById('center-content');
            centerDiv.innerHTML = '';
            if (activeBattleNft) {
                centerDiv.innerHTML = `
                    <img src="${activeBattleNft.img}" class="center-nft-img" alt="${activeBattleNft.name}">
                    <div class="center-nft-name">${activeBattleNft.name}</div>
                    <div class="center-nft-status">Готов к дуэли</div>
                `;
            } else {
                centerDiv.innerHTML = '<div class="center-logo">//</div><div class="center-message">У вас не выбран NFT для дуэли, выберите его в <span class="clickable-link" onclick="switchScreen(\'collection\')">коллекции</span></div>';
            }
        }

        function renderCollection() {
            const grid = document.getElementById('collection-grid');
            grid.innerHTML = '';
            
            if (collection.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888888;">Коллекция пуста<br>Купите NFT в магазине</div>';
            } else {
                collection.forEach((nft, index) => {
                    const isActive = activeBattleNft && activeBattleNft.name === nft.name && activeBattleNft.img === nft.img;
                    const card = document.createElement('div');
                    card.className = 'nft-card';
                    card.innerHTML = `
                        <img src="${nft.img}" class="nft-card-img" alt="${nft.name}">
                        <div class="nft-card-name">${nft.name} ${isActive ? '⚔️' : ''}</div>
                        <div class="nft-card-price">Куплено за ${nft.buyPrice} звёзд</div>
                        <button class="nft-card-btn" onclick="setToBattle(${index})" ${isActive ? 'disabled' : ''}>
                            ${isActive ? 'Готов к дуэли' : 'К дуэли'}
                        </button>
                        <button class="nft-card-btn secondary" onclick="sellNft(${index})">
                            Продать ${Math.floor(nft.buyPrice * 0.8)} звёзд
                        </button>
                    `;
                    grid.appendChild(card);
                });
            }
        }

        function renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            
            nftTemplates.forEach((template, index) => {
                const price = nftPrices[index];
                const card = document.createElement('div');
                card.className = 'nft-card';
                card.innerHTML = `
                    <img src="${template.img}" class="nft-card-img" alt="${template.name}">
                    <div class="nft-card-name">${template.name}</div>
                    <div class="nft-card-price">${price} звёзд</div>
                    <button class="nft-card-btn" onclick="buyNft(${index}, ${price})" ${stars < price ? 'disabled' : ''}>
                        ${stars < price ? 'Недостаточно звёзд' : 'Купить'}
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        function renderProfile() {
            const grid = document.getElementById('profile-collection');
            grid.innerHTML = '';
            
            if (collection.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888888;">У вас пока нет NFT</div>';
            } else {
                collection.forEach((nft) => {
                    const isActive = activeBattleNft && activeBattleNft.name === nft.name && activeBattleNft.img === nft.img;
                    const card = document.createElement('div');
                    card.className = 'nft-card';
                    card.innerHTML = `
                        <img src="${nft.img}" class="nft-card-img" alt="${nft.name}">
                        <div class="nft-card-name">${nft.name} ${isActive ? '⚔️' : ''}</div>
                        <div class="nft-card-price">Стоимость: ${nft.buyPrice} звёзд</div>
                    `;
                    grid.appendChild(card);
                });
            }
        }

        function buyNft(templateIndex, price) {
            if (stars >= price) {
                stars -= price;
                const nft = { ...nftTemplates[templateIndex], buyPrice: price };
                collection.push(nft);
                updateUI();
                alert(`Куплен ${nft.name}!`);
                renderShop();
                
                setTimeout(() => {
                    switchScreen('collection');
                    renderCollection();
                }, 500);
            } else {
                alert('Недостаточно звёзд!');
            }
        }

        function sellNft(index) {
            const nft = collection[index];
            const sellPrice = Math.floor(nft.buyPrice * 0.8);
            stars += sellPrice;
            
            if (activeBattleNft && activeBattleNft.name === nft.name && activeBattleNft.img === nft.img) {
                activeBattleNft = null;
            }
            
            collection.splice(index, 1);
            updateUI();
            renderCollection();
            renderCenterArea();
            alert(`Продан за ${sellPrice} звёзд!`);
        }

        function showRules() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('rules-screen').classList.add('active');
        }

        function backToMainFromRules() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('main-screen').classList.add('active');
            document.querySelectorAll('.nav-item')[0].classList.add('active');
        }

        function setToBattle(index) {
            activeBattleNft = collection[index];
            renderCollection();
            renderCenterArea();
            updateUI();
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('main-screen').classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[0].classList.add('active');
            
            currentScreen = 'main';
        }

        function showBattleHistory() {
            document.getElementById('profile-screen').classList.remove('active');
            document.getElementById('battle-history-screen').classList.add('active');
            renderBattleHistory();
        }

        function backToProfile() {
            document.getElementById('battle-history-screen').classList.remove('active');
            document.getElementById('profile-screen').classList.add('active');
        }

        function renderBattleHistory() {
            const historyList = document.getElementById('battle-history-list');
            historyList.innerHTML = '';
            
            if (battleHistory.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #888888;">История дуэлей пуста<br>Проведите первую дуэль!</div>';
                return;
            }
            
            battleHistory.slice().reverse().forEach(battle => {
                const historyItem = document.createElement('div');
                historyItem.className = 'battle-history-item';
                
                historyItem.innerHTML = `
                    <div class="battle-history-header">
                        <span class="battle-result-text ${battle.result}">${battle.result === 'win' ? 'ПОБЕДА' : 'ПОРАЖЕНИЕ'}</span>
                        <span style="color: #888888; font-size: 14px;">${battle.date}</span>
                    </div>
                    <div class="battle-history-nfts">
                        <div class="history-nft">
                            <img src="${battle.playerNft.img}" class="history-nft-img" alt="${battle.playerNft.name}">
                            <div class="history-nft-name">${battle.playerNft.name}</div>
                        </div>
                        <div class="history-vs">VS</div>
                        <div class="history-nft">
                            <img src="${battle.botNft.img}" class="history-nft-img" alt="${battle.botNft.name}">
                            <div class="history-nft-name">${battle.botNft.name}</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 14px; color: #cccccc;">
                        ${battle.reward}${battle.starsWon ? ` (+${battle.starsWon} звёзд)` : ''}
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }
    </script>
</body>
</html>
